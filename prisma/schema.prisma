generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id              String               @id @default(cuid()) @map("user_id")
  name                 String?              @map("name")
  email                String               @unique @map("email")
  password             String               @map("password")
  image                String?              @map("image")
  email_verified       DateTime?            @map("email_verified")
  is_admin             Boolean              @default(false) @map("is_admin")
  role                 UserRole             @default(USER) @map("role")
  email_notifications  Boolean              @default(true) @map("email_notifications")
  in_app_notifications Boolean              @default(true) @map("in_app_notifications")
  created_at           DateTime             @default(now()) @map("created_at")
  updated_at           DateTime             @updatedAt @map("updated_at")
  paddle_customer_id   String?              @unique @map("paddle_customer_id")
  ownedBundles         Bundle[]
  feedback             EpisodeFeedback[]
  notifications        Notification[]
  ownedPodcasts        Podcast[]
  subscriptions        Subscription[]
  userCurationProfile  UserCurationProfile?
  userEpisodes         UserEpisode[]
  sharedBundles        SharedBundle[]
  ingestionConfig      UserIngestionConfig?
  youtubeFeedEntries   YoutubeFeedEntry[]
  researchAssets       ResearchAsset[]

  @@map("user")
}

/// ───────────────────────────────────
/// RESEARCH VAULT ASSETS
/// ───────────────────────────────────
model ResearchAsset {
  id            String   @id @default(cuid()) @map("id")
  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [user_id], onDelete: Cascade)
  
  // Source Data
  sourceUrl     String   @map("source_url")
  cachedContent String   @map("cached_content") @db.Text
  
  // User-Defined Metadata
  title         String   @map("title")
  description   String?  @map("description") @db.Text
  assetType     String   @map("asset_type")
  tags          String[] @map("tags")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("research_asset")
}

/// ───────────────────────────────────
/// USER-generated summaries
/// ───────────────────────────────────
model UserEpisode {
  episode_id           String                @id @default(uuid()) @map("episode_id")
  user_id              String                @map("user_id")
  episode_title        String                @map("episode_title")
  youtube_url          String                @map("youtube_url")
  transcript           String?               @map("transcript") @db.Text
  summary              String?               @map("summary") @db.Text
  summary_length       String                @default("MEDIUM") @map("summary_length")
  gcs_audio_url        String?               @map("gcs_audio_url")
  is_public            Boolean               @default(false) @map("is_public")
  public_gcs_audio_url String?               @map("public_gcs_audio_url")
  duration_seconds     Int?                  @map("duration_seconds")
  status               UserEpisodeStatus     @default(PENDING) @map("status")
  progress_message     String?               @map("progress_message")
  auto_generated       Boolean               @default(false) @map("auto_generated")
  // B2B Intelligence Fields
  sentiment            MarketSentiment?      @map("sentiment")
  sentiment_score      Float?                @map("sentiment_score") // -1.0 to 1.0
  mentioned_assets     Json?                 @map("mentioned_assets") // JSON array of MentionedAsset
  voice_archetype      String?               @map("voice_archetype")
  reference_doc_url    String?               @map("reference_doc_url")
  context_weight       Float?                @map("context_weight")
  intelligence         Json?                 @map("intelligence") // Stores { sentiment, assets, risks }
  
  created_at           DateTime              @default(now()) @map("created_at")
  updated_at           DateTime              @updatedAt @map("updated_at")
  user                 User                  @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  sharedBundleEpisodes SharedBundleEpisode[]

  @@index([user_id])
  @@index([is_public])
  @@index([user_id, auto_generated])
  @@map("user_episode")
}

enum MarketSentiment {
  BULLISH
  NEUTRAL
  BEARISH
}

/// ───────────────────────────────────
/// UNIFIED PODCAST CATALOG
/// ───────────────────────────────────
model Podcast {
  podcast_id      String           @id @default(uuid()) @map("podcast_id")
  name            String           @map("name")
  description     String?          @map("description")
  url             String           @unique @map("url")
  image_url       String?          @map("image_url")
  category        String?          @map("category")
  is_active       Boolean          @default(true) @map("is_active")
  owner_user_id   String?          @map("owner_user_id")
  created_at      DateTime         @default(now()) @map("created_at")
  bundle_podcast  BundlePodcast[]
  episodes        Episode[]
  ownerUser       User?            @relation(fields: [owner_user_id], references: [user_id])
  profile_podcast ProfilePodcast[]

  @@index([owner_user_id])
  @@index([is_active])
  @@map("podcast")
}

/// ───────────────────────────────────
/// UNIFIED EPISODE TABLE
/// ───────────────────────────────────
model Episode {
  episode_id       String               @id @default(uuid()) @map("episode_id")
  podcast_id       String               @map("podcast_id")
  profile_id       String?              @map("profile_id")
  bundle_id        String?              @map("bundle_id")
  title            String               @map("title")
  description      String?              @map("description")
  audio_url        String               @map("audio_url")
  image_url        String?              @map("image_url")
  duration_seconds Int?                 @map("duration_seconds")
  published_at     DateTime?            @map("published_at")
  week_nr          DateTime?            @map("week_nr")
  created_at       DateTime             @default(now()) @map("created_at")
  bundle           Bundle?              @relation(fields: [bundle_id], references: [bundle_id])
  podcast          Podcast              @relation(fields: [podcast_id], references: [podcast_id], onDelete: Cascade)
  userProfile      UserCurationProfile? @relation(fields: [profile_id], references: [profile_id])
  feedback         EpisodeFeedback[]

  @@index([podcast_id, week_nr], map: "episode_podcast_week_idx")
  @@index([published_at])
  @@index([profile_id], map: "episode_profile_idx")
  @@index([bundle_id], map: "episode_bundle_idx")
  @@map("episode")
}

/// ───────────────────────────────────
/// BUNDLES (static or user-custom)
/// ───────────────────────────────────
model Bundle {
  bundle_id             String                @id @default(uuid()) @map("bundle_id")
  name                  String                @map("name")
  description           String?               @map("description")
  image_data            Bytes?                @map("image_data")
  image_type            String?               @map("image_type")
  is_static             Boolean               @default(true) @map("is_static")
  is_active             Boolean               @default(true) @map("is_active")
  owner_user_id         String?               @map("owner_user_id")
  min_plan              PlanGate              @default(NONE) @map("min_plan")
  created_at            DateTime              @default(now()) @map("created_at")
  ownerUser             User?                 @relation(fields: [owner_user_id], references: [user_id])
  bundle_podcast        BundlePodcast[]
  episodes              Episode[]
  user_curation_profile UserCurationProfile[]

  @@index([is_static, is_active], map: "bundle_static_active_idx")
  @@index([owner_user_id], map: "bundle_owner_idx")
  @@map("bundle")
}

/// Junction table: Bundle ↔ Podcast
model BundlePodcast {
  bundle_id  String  @map("bundle_id")
  podcast_id String  @map("podcast_id")
  bundle     Bundle  @relation(fields: [bundle_id], references: [bundle_id], onDelete: Cascade)
  podcast    Podcast @relation(fields: [podcast_id], references: [podcast_id], onDelete: Cascade)

  @@id([bundle_id, podcast_id])
  @@map("bundle_podcast")
}

/// ───────────────────────────────────
/// USER CURATION PROFILES
/// ───────────────────────────────────
model UserCurationProfile {
  profile_id                String           @id @default(uuid()) @map("profile_id")
  user_id                   String           @unique @map("user_id")
  name                      String           @map("name")
  audio_url                 String?          @map("audio_url")
  image_url                 String?          @map("image_url")
  created_at                DateTime         @default(now()) @map("created_at")
  updated_at                DateTime         @updatedAt @map("updated_at")
  generated_at              DateTime?        @map("generated_at")
  last_generation_date      DateTime?        @map("last_generation_date")
  next_generation_date      DateTime?        @map("next_generation_date")
  is_active                 Boolean          @default(true) @map("is_active")
  is_bundle_selection       Boolean          @default(false) @map("is_bundle_selection")
  selected_bundle_id        String?          @map("selected_bundle_id")
  selected_shared_bundle_id String?          @map("selected_shared_bundle_id")
  episodes                  Episode[]
  profile_podcast           ProfilePodcast[]
  selectedBundle            Bundle?          @relation(fields: [selected_bundle_id], references: [bundle_id])
  selectedSharedBundle      SharedBundle?    @relation(fields: [selected_shared_bundle_id], references: [shared_bundle_id])
  user                      User             @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@map("user_curation_profile")
}

/// Junction table: UserCurationProfile ↔ Podcast
model ProfilePodcast {
  profile_id String              @map("profile_id")
  podcast_id String              @map("podcast_id")
  podcast    Podcast             @relation(fields: [podcast_id], references: [podcast_id], onDelete: Cascade)
  profile    UserCurationProfile @relation(fields: [profile_id], references: [profile_id], onDelete: Cascade)

  @@id([profile_id, podcast_id])
  @@map("profile_podcast")
}

/// ───────────────────────────────────
/// SUPPORTING MODELS (unchanged logic)
/// ───────────────────────────────────
model Notification {
  notification_id String   @id @default(uuid()) @map("notification_id")
  user_id         String   @map("user_id")
  type            String   @map("type")
  message         String   @map("message")
  is_read         Boolean  @default(false) @map("is_read")
  created_at      DateTime @default(now()) @map("created_at")
  user            User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@map("notification")
}

model Subscription {
  subscription_id        String    @id @default(uuid()) @map("subscription_id")
  user_id                String    @map("user_id")
  paddle_subscription_id String?   @unique @map("paddle_subscription_id")
  paddle_price_id        String?   @map("paddle_price_id")
  plan_type              String    @default("casual_listener") @map("plan_type")
  status                 String    @default("trialing") @map("status")
  current_period_start   DateTime? @map("current_period_start")
  current_period_end     DateTime? @map("current_period_end")
  trial_start            DateTime? @map("trial_start")
  trial_end              DateTime? @map("trial_end")
  canceled_at            DateTime? @map("canceled_at")
  cancel_at_period_end   Boolean   @default(false) @map("cancel_at_period_end")
  episode_creation_count Int       @default(0) @map("episode_creation_count")
  created_at             DateTime  @default(now()) @map("created_at")
  updated_at             DateTime  @updatedAt @map("updated_at")
  user                   User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@map("subscription")
}

model EpisodeFeedback {
  feedback_id String         @id @default(uuid()) @map("feedback_id")
  user_id     String         @map("user_id")
  episode_id  String         @map("episode_id")
  rating      FeedbackRating @map("rating")
  created_at  DateTime       @default(now()) @map("created_at")
  updated_at  DateTime       @updatedAt @map("updated_at")
  episode     Episode        @relation(fields: [episode_id], references: [episode_id], onDelete: Cascade)
  user        User           @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([user_id, episode_id])
  @@map("episode_feedback")
}

enum FeedbackRating {
  THUMBS_UP
  THUMBS_DOWN
  NEUTRAL
}

enum UserEpisodeStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

/// Access gate for curated bundles
enum PlanGate {
  NONE
  CASUAL_LISTENER
  CURATE_CONTROL
  FREE_SLICE
}

enum UserRole {
  USER
  ADMIN
}

/// ───────────────────────────────────
/// YOUTUBE RSS FEED ENTRIES
/// ───────────────────────────────────
model YoutubeFeedEntry {
  id             String    @id @default(cuid()) @map("id")
  user_id        String    @map("user_id")
  video_url      String    @map("video_url")
  video_title    String    @map("video_title")
  published_date DateTime? @map("published_date")
  fetched_at     DateTime  @default(now()) @map("fetched_at")
  created_at     DateTime  @default(now()) @map("created_at")
  processed      Boolean   @default(false) @map("processed")
  user           User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([user_id, video_url])
  @@index([user_id])
  @@index([published_date])
  @@index([user_id, processed])
  @@map("youtube_feed_entry")
}

/// ───────────────────────────────────
/// SHARED BUNDLES (User-Generated)
/// ───────────────────────────────────
model SharedBundle {
  shared_bundle_id       String                @id @default(uuid()) @map("shared_bundle_id")
  owner_user_id          String                @map("owner_user_id")
  name                   String                @map("name")
  description            String?               @map("description")
  is_active              Boolean               @default(true) @map("is_active")
  created_at             DateTime              @default(now()) @map("created_at")
  updated_at             DateTime              @updatedAt @map("updated_at")
  owner                  User                  @relation(fields: [owner_user_id], references: [user_id], onDelete: Cascade)
  episodes               SharedBundleEpisode[]
  user_curation_profiles UserCurationProfile[]

  @@index([owner_user_id])
  @@index([is_active])
  @@map("shared_bundle")
}

/// Junction table: SharedBundle ↔ UserEpisode
model SharedBundleEpisode {
  shared_bundle_id String       @map("shared_bundle_id")
  episode_id       String       @map("episode_id")
  is_active        Boolean      @default(true) @map("is_active")
  display_order    Int?         @map("display_order")
  added_at         DateTime     @default(now()) @map("added_at")
  sharedBundle     SharedBundle @relation(fields: [shared_bundle_id], references: [shared_bundle_id], onDelete: Cascade)
  userEpisode      UserEpisode  @relation(fields: [episode_id], references: [episode_id], onDelete: Cascade)

  @@id([shared_bundle_id, episode_id])
  @@index([shared_bundle_id])
  @@index([episode_id])
  @@map("shared_bundle_episode")
}

/// ───────────────────────────────────
/// USER INGESTION CONFIGURATION
/// ───────────────────────────────────
model UserIngestionConfig {
  id      String @id @default(cuid()) @map("id")
  user_id String @unique @map("user_id")
  user    User   @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  topic        String? @map("topic")
  rss_feed_url String? @map("rss_feed_url")
  api1_url     String? @map("api1_url")
  api2_url     String? @map("api2_url")

  is_active  Boolean  @default(true) @map("is_active")
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  @@map("user_ingestion_config")
}
